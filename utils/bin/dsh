#!/bin/bash

PROGRAM=$(basename $0)
PROJECT=$(basename $PWD)
IMAGE=$PROGRAM/$PROJECT
[ -n "$DSH_IMAGE" ] && IMAGE=$DSH_IMAGE
ARGS=--detach-keys="ctrl-@"
CMD=$1; shift

if [ -z "$CMD" ]; then
    if ! podman image exists $IMAGE; then
	echo "No image $IMAGE" >&2
	exit 1
    fi
    if podman container exists $PROJECT; then
	podman start $PROJECT >/dev/null
	podman attach $ARGS $PROJECT
    else
	podman run \
	    -it \
	    --name $PROJECT \
	    --hostname $PROJECT \
	    --privileged \
	    --volume=$PWD:/src \
	    --workdir /src \
	    $ARGS $IMAGE
    fi
elif [ "$CMD" == "exec" ]; then
    podman exec -it $PROJECT $@
elif [ "$CMD" == "rm" ]; then
    podman rm $PROJECT
fi
