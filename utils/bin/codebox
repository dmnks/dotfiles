#!/bin/bash

PROGRAM=codebox
PROJECT=$(basename $PWD)
DOCKERFILE=Dockerfile
IMAGE=$PROGRAM/$PROJECT
NAME=$PROGRAM-$PROJECT

build() {
    local file=Dockerfile
    [ -n "$1" ] && file=$1
    podman build -t $IMAGE -f $file
    chcon -R -t container_file_t $PWD
}

run() {
    podman run \
        -it -e TERM -v=$PWD:/src/$PROJECT \
        --workdir /src/$PROJECT \
        --name $NAME \
        --hostname $PROGRAM \
        $@ $IMAGE
}

CMD=$1; shift
if [ -z "$CMD" ]; then
    usage
elif [ "$CMD" == "build" ]; then
    build $@
elif [ "$CMD" == "sh" ]; then
    podman image exists $IMAGE || build $@
    if podman container exists $NAME; then
        podman start $NAME >/dev/null
        podman attach $NAME
    else
        run $@
    fi
elif [ "$CMD" == "rm" ]; then
    podman container exists $NAME && podman rm $NAME
fi
