#!/bin/bash

PROGRAM=codebox
DATADIR=.$PROGRAM
PROJECT=$(basename $PWD)
IMAGE=$PROGRAM/$PROJECT
NAME=$PROGRAM-$PROJECT

build() {
    podman build -t $IMAGE $DATADIR
    chcon -R -t container_file_t $PWD
}

run() {
    podman run \
        -it -e TERM \
        --name $NAME \
        --hostname $PROGRAM \
        --privileged \
        --workdir /src \
        --volume=$PWD:/src \
        --volume=$PWD/$DATADIR:/data \
	--detach-keys="ctrl-@" \
        $IMAGE
}

CMD=$1; shift
if [ -z "$CMD" ]; then
    usage
elif [ "$CMD" == "build" ]; then
    build $@
elif [ "$CMD" == "sh" ]; then
    podman image exists $IMAGE || build
    if podman container exists $NAME; then
        podman start $NAME >/dev/null
        podman attach $NAME
    else
        run
    fi
elif [ "$CMD" == "rm" ]; then
    podman container exists $NAME && podman rm $NAME
fi
