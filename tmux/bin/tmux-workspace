#!/bin/bash

if [ "$1" == "-s" ]; then
    topdir=$(dirname $PWD)
    i=1

    list=$(git worktree list | sed 's/^.\+\///')
    this=$(tmux display-message -p '#S' | cut -d/ -f2)
    select=$(( $(echo "$list" | sed -n "/$this/=") - 1 ))

    echo "$list" | while read line; do
        name=$(echo "$line" | cut -d' ' -f1)
        if tmux list-sessions -F '#S' | grep -q $name; then
            prefix="*"
        else
            prefix=" "
        fi
        echo "'$prefix $line' $i \
              \"run-shell 'cd $topdir/$name && tmux-workspace'\""
        i=$(( i + 1 ))
    done | xargs tmux display-menu -x0 -yS -C$select

    exit 0
fi

[ $# == 0 ] && set -- $(dirname $PWD | xargs basename)/$(basename $PWD)

if [ -z "$TMUX" ]; then
    size=12
else
    size=11
fi

if ! tmux has-session -t "$1" 2>/dev/null; then
    tmux new-session -ds "$1" -n "code" \
                     -x "$(tput cols)" -y "$(tput lines)" "vim"
    tmux new-window -t "$1" -n "git" "tig status"
    tmux split-window -t "$1" -l$size -d
    tmux new-window -t "$1" -n "build"
    tmux new-window -t "$1" -n "debug"
    tmux split-window -t "$1" -l$size -d
    tmux select-window -t ${1}:+1
fi

if [ -z "$TMUX" ]; then
    tmux attach -t "$1"
else
    tmux switch-client -t "$1"
fi
