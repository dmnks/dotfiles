#!/bin/bash
# Generate a diary for the given RH fiscal year.

WIKI=$HOME/vimwiki/diary
FISCAL=$1
TITLE="FY$FISCAL"
BEGIN="20$(( $FISCAL - 1 ))-03-01"

days() {
    local date=$1
    local end=$2
    local week=$(date -d"$date" +"%W")
    local lastweek=
    while [[ "$date" != "$end" ]]; do
        local name=$(date -d"$date" +"%a")
        if [[ "$name" != "Sat" && "$name" != "Sun" ]]; then
            week=$(date -d"$date" +"%W")
            if [[ "$week" != "$lastweek" ]]; then
                echo
                echo "== Week $week =="
                lastweek=$week
            fi
            local day=$(date -d"$date" +"%Y-%m-%d")
            echo "* [[$day|$name $day]]"
        fi
        date=$(date -I -d"$date +1day")
    done
}

quarter() {
    local date=$1
    for month in $(seq 1 3); do
        local name=$(date -d"$date" +"%b")
        local file="$TITLE$name"
        echo "* [[$file|"$(date -d"$date" +"%B")"]]"
        end=$(date -I -d"$date +1month")
        echo "= $name $TITLE =" > $file.wiki
        days $date $end >> $file.wiki
        date=$end
    done
}

fiscal() {
    local date=$1
    for quart in $(seq 1 4); do
        echo
        echo "== Quarter $quart =="
        quarter $date
        date=$(date -I -d"$date +3months")
    done
}

cd $WIKI
echo "= Diary $TITLE =" > $TITLE.wiki
fiscal $BEGIN >> $TITLE.wiki
