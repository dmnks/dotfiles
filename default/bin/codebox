#!/bin/bash

PROGNAME="codebox"

usage() {
    echo "\
Usage: $PROGNAME COMMAND [ARGS]

Simple development environment within the current directory.

Commands:
    create      create new box
    enter       attach to box
    ls          list all boxes
    rm          remove box"
    exit 1
}

NAME="$PROGNAME-"$(basename $PWD)

ensure_box_exists() {
    if ! podman container exists $NAME; then
        >&2 echo "No box has been created here yet"
        >&2 echo "Use '$PROGNAME create'"
        exit 1
    fi
}

ensure_no_box_exists() {
    if podman container exists $NAME; then
        >&2 echo "Box already exists here"
        >&2 echo "Use '$PROGNAME enter'"
        exit 1
    fi
}

CMD=$1
if [ -z "$CMD" ]; then
    usage
elif [ "$CMD" == "create" ]; then
    ensure_no_box_exists
    if ! podman image exists $NAME; then
        >&2 echo "No box image exists"
        >&2 echo "Create it with 'podman build -t $NAME /path/to/context'"
        exit 1
    fi
    DEST=/root/$(echo $PWD | sed "s,$HOME/,,")
    podman create \
         -e TERM -it \
         -v=$PWD:$DEST \
         -v=$HOME/.bashrc:/root/.bashrc:ro \
         --workdir $DEST \
         --name $NAME \
         --hostname $PROGNAME \
         --network host \
         -it $NAME >/dev/null
    chcon -R -t container_file_t $PWD
    echo "Box created, use '$PROGNAME enter'"
elif [ "$CMD" == "enter" ]; then
    ensure_box_exists
    podman start $NAME >/dev/null
    podman attach --detach-keys="ctrl-@" $NAME
elif [ "$CMD" == "ls" ]; then
    OUTPUT=$(podman ps -a)
    MATCHES=$(echo "$OUTPUT" | grep $PROGNAME)
    [ "$MATCHES" == "" ] && exit 0
    echo "$OUTPUT" | head -1
    echo "$MATCHES"
elif [ "$CMD" == "rm" ]; then
    ensure_box_exists
    podman rm -f $NAME >/dev/null
else
    usage
fi

exit 0
